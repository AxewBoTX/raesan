{% import "../components/hovering_buttons.html" as hovering_buttons %}
{% import "../components/create_modal.html" as create_modal %}
{% import "../components/create_from_json_modal.html" as create_from_json_modal %}

{% extends "../base.html" %} 

{% block page_scripts %}
<script>
	// handle create_class_form submition
	const handleCreateClassFormSubmit = () => {
		let create_class_form = document.getElementById("create_class_form");
		if (create_class_form.elements["name"].value.trim() === "" && create_class_form.elements["name"].value.trim().length === 0){
			alert("Atleast enter something!");
		}else{
			fetch("/api/class",{
				method: "POST",
				headers: {
					"Content-Type": "application/json"
				},
				body: JSON.stringify({
					id: "",
					name: parseInt(create_class_form.elements["name"].value),
				})
			}).then((res) => {
				if (!res.ok){
					throw new Error(`HTTP error! Status: ${res.status}`);
				}
				return res.json();
			}).then((data) => {
				if (document.getElementById("create_class_modal")){
					document.getElementById("create_class_modal").close();
					document.getElementById("class_table_body").innerHTML += `
					<tr id="${data.id}">
						<td>${data.id}</td>
						<td>${data.name}</td>
						<th>
							<button 
								class="cursor-pointer iconify mdi--bin-outline text-red-500 w-[22px] h-[22px]" 
								onclick="deleteClass('${data.id}','${data.id}')"
							></button>
						</th>
					</tr>
					`;
				}
			});
		}
	};


	// handle create_class_from_json_input submition
	document.getElementById("create_class_from_json_input").value = "";
	const handleCreateClassFromJsonFormSubmit = () => {
		let create_class_from_json_input = document.getElementById("create_class_from_json_input");
		if (create_class_from_json_input.value.trim() === "" && create_class_from_json_input.value.trim().length === 0){
			alert("Atleast enter something!");
		}else{
			fetch("/api/class/json",{
				method: "POST",
				headers: {
					"Content-Type": "application/json"
				},
				body: JSON.stringify(JSON.parse(create_class_from_json_input.value)).trim()
			}).then((res) => {
				if (!res.ok){
					throw new Error(`HTTP error! Status: ${res.status}`);
				}
				return res.json();
			}).then((data) => {
				if (document.getElementById("create_class_from_json_modal")){
					document.getElementById("create_class_from_json_modal").close();
					data.forEach((element) => {
						document.getElementById("class_table_body").innerHTML += `
						<tr id="${element.id}">
							<td>${element.id}</td>
							<td>${element.name}</td>
							<th>
								<button 
									class="cursor-pointer iconify mdi--bin-outline text-red-500 w-[22px] h-[22px]" 
									onclick="deleteClass('${element.id}','${element.id}')"
								></button>
							</th>
						</tr>
						`;
					});
				}
			});
		}
	}

	// delete class handler
	const deleteClass = (class_id,class_name) => {
		let choice = confirm(`WARNING! Do you want to delete 'Class ${class_name}'`)
		if (choice == true){
			fetch(`/api/class/${class_id}`,{
				method: "DELETE"
			}).then((res) => {
				if (!res.ok){
					throw new Error(`HTTP error! Status: ${res.status}`);
				}
				return res.text();
			}).then((data) => {
				document.getElementById(class_id).remove();
			});
		}
	}
</script>
{% endblock %}

{% block page_content %}

<!-- hovering buttons -->
{% call hovering_buttons::component("create_class_modal.showModal()","create_class_from_json_modal.showModal()") %}

<!-- create class modal -->
{% call create_modal::component("Class","handleCreateClassFormSubmit()","
	<input type='number' name='name' placeholder='Name' class='input input-bordered w-full max-w-xs' />
") %}

<!-- create class from json modal -->
{% call create_from_json_modal::component("Class","handleCreateClassFromJsonFormSubmit()","[
	{
		'id': '--this-should-be-empty--',
		'name': 0 
	},
	{
		'id': '--this-should-be-empty--',
		'name': 1
	}
]") %}

<!-- main page body -->
<main class="w-full flex flex-col items-center mt-[120px] gap-[25px]">
	<h2 class="text-2xl">Classses</h2>
	<div class="overflow-x-auto w-full max-w-[1400px] px-4">
	  	<table class="table table-lg bg-base-200 mb-[150px] w-full">
			<thead>
				<tr class="bg-base-300">
					<th>ID</th>
					<th>Name</th>
					<th></th>
				</tr>
			</thead>
			<tbody id="class_table_body">
				{% for class in classes %}
				<tr id="{{ class.id }}">
					<td>{{ class.id }}</td>
					<td>{{ class.name }}</td>
					<th>
						<button 
							class="cursor-pointer iconify mdi--bin-outline text-red-500 w-[22px] h-[22px]" 
							onclick="deleteClass('{{ class.id }}','{{ class.name }}')"
						></button>
					</th>
				</tr>
				{% endfor %}
			</tbody>
		</table>
	</div>
</main>

{% endblock %}
