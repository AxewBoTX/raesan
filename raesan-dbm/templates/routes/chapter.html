{% import "../components/hovering_buttons.html" as hovering_buttons %}
{% import "../components/create_modal.html" as create_modal %}
{% import "../components/create_from_json_modal.html" as create_from_json_modal %}

{% extends "../base.html" %} 

{% block page_scripts %}
<script>
	// handle create_chapter_form submition
	const handleCreateChapterFormSubmit = () => {
		let create_chapter_form = document.getElementById("create_chapter_form");
		if (
			(create_chapter_form.elements["name"].value.trim() === "" && create_chapter_form.elements["name"].value.trim().length === 0) ||
			(create_chapter_form.elements["subject_id"].value.trim() === "" && create_chapter_form.elements["subject_id"].value.trim().length === 0) ||
			(create_chapter_form.elements["subject_name"].value.trim() === "" && create_chapter_form.elements["subject_name"].value.trim().length === 0) ||
			(create_chapter_form.elements["class_name"].value.trim() === "" && create_chapter_form.elements["chapter_name"].value.trim().length === 0)
		){
			alert("You cannot leave things empty!");
		}else{
			fetch("/api/chapter",{
				method: "POST",
				headers: {
					"Content-Type": "application/json"
				},
				body: JSON.stringify({
					id: "",
					name: create_chapter_form.elements["name"].value,
					subject_id: create_chapter_form.elements["subject_id"].value,
					subject_name: create_chapter_form.elements["subject_name"].value,
					class_name: parseInt(create_chapter_form.elements["class_name"].value),
				})
			}).then((res) => {
				if (!res.ok){
					throw new Error(`HTTP error! Status: ${res.status}`);
				}
				return res.json();
			}).then((data) => {
				if (document.getElementById("create_chapter_modal")){
					document.getElementById("create_chapter_modal").close();
				}
			});
		}
	};
	
	// handle create_chapter_from_json_input submition
	document.getElementById("create_chapter_from_json_input").value = "";
	const handleCreateChapterFromJsonFormSubmit = () => {
		let create_chapter_from_json_input = document.getElementById("create_chapter_from_json_input");
		if (create_chapter_from_json_input.value.trim() === "" && create_chapter_from_json_input.value.trim().length === 0){
			alert("Atleast enter something!");
		}else{
			fetch("/api/chapter/json",{
				method: "POST",
				headers: {
					"Content-Type": "application/json"
				},
				body: JSON.stringify(JSON.parse(create_chapter_from_json_input.value)).trim()
			}).then((res) => {
				if (!res.ok){
					throw new Error(`HTTP error! Status: ${res.status}`);
				}
				return res.json();
			}).then((data) => {
				if (document.getElementById("create_chapter_from_json_modal")){
					document.getElementById("create_chapter_from_json_modal").close();
				}
			});
		}
	}

	// delete chapter handler
	const deleteChapter = (chapter_id,chapter_name) => {
		let choice = confirm(`WARNING! Do you want to delete '${chapter_name}'`)
		if (choice == true){
			fetch(`/api/chapter/${chapter_id}`,{
				method: "DELETE"
			}).then((res) => {
				if (!res.ok){
					throw new Error(`HTTP error! Status: ${res.status}`);
				}
				return res.text();
			}).then((data) => {
				document.getElementById(chapter_id).remove();
			});
		}
	}

	let curr_page = 1;
	// Function to fetch and append new data
	function fetchAndAppendData() {
		let chapter_table_body = document.getElementById("chapter_table_body");
		curr_page += 1;

		fetch(`/api/chapter?page=${curr_page}`, { method: "GET" })
			.then((response) => {
				if (!response.ok) {
					throw new Error(`HTTP error! Status: ${response.status}`);
				}
				return response.json();
			})
			.then((data) => {
				if (data.length === 0) {
					// If no more data, stop observing
					observer.disconnect();
					return;
				}

				// Append the new data to the table body
				data.forEach((element) => {
					chapter_table_body.innerHTML += `
					<tr id="${element.id}">
						<td>${element.id}</td>
						<td>${element.name}</td>
						<td>${element.subject_name}</td>
						<td>${element.class_name}</td>
						<th>
							<button 
								class="cursor-pointer iconify mdi--bin-outline w-[22px] h-[22px] text-red-500" 
								onclick="deleteChapter('${element.id}','${element.name}')"
							></button>
						</th>
					</tr>
					`;
				});

				// Update the observer to observe the new last element
				const newLastElement = chapter_table_body.lastElementChild;
				if (newLastElement) {
					observer.observe(newLastElement);
				}
			})
			.catch((err) => {
				console.error('Failed to fetch data:', err);
			});
	}

	// IntersectionObserver to load more data when the last element is visible
	const observer = new IntersectionObserver((entries) => {
		entries.forEach(entry => {
			if (entry.isIntersecting) {
				// Stop observing the current element
				observer.unobserve(entry.target);
				// Fetch and append new data
				fetchAndAppendData();
			}
		});
	}, {
		threshold: 0.1 // when at least 10% of the element is visible
	});

	// Start observing when the page loads
	document.addEventListener("DOMContentLoaded", () => {
		const initialLastElement = document.getElementById("chapter_table_body").lastElementChild;
		if (initialLastElement) {
			observer.observe(initialLastElement);
		}
	});
</script>
{% endblock %}

{% block page_content %}

<!-- hovering buttons -->
{% call hovering_buttons::component("create_chapter_modal.showModal()","create_chapter_from_json_modal.showModal()") %}

<!-- create chapter modal -->
{% call create_modal::component("Chapter","handleCreateChapterFormSubmit()","
	<input
	  type='text'
	  name='name'
	  placeholder='Name'
	  class='input input-bordered w-full max-w-xs'
	/>
	<input
	  type='text'
	  name='subject_id'
	  placeholder='Subject ID'
	  class='input input-bordered w-full max-w-xs'
	/>
	<input
	  type='text'
	  name='subject_name'
	  placeholder='Subject Name'
	  class='input input-bordered w-full max-w-xs'
	/>
	<input
	  type='number'
	  name='class_name'
	  placeholder='Class Name'
	  class='input input-bordered w-full max-w-xs'
	/>
") %}

<!-- create chapter from json modal -->
{% call create_from_json_modal::component("Chapter","handleCreateChapterFromJsonFormSubmit()","[
	{
		'id': '--this-should-be-empty',
		'name': 'some-name',
		'subject_id': 'some-subject-id',
		'subject_name': 'some-subject-name',
		'class_name': 11
	},
	{
		'id': '--this-should-be-empty',
		'name': 'some-name-2',
		'subject_id': 'some-subject-id-2',
		'subject_name': 'some-subject-name-2',
		'class_name': 11
	}
]") %}


<!-- main page body -->
<main class="w-full flex flex-col items-center mt-[120px] gap-[25px]">
	<h2 class="text-2xl">Chapters</h2>
	<div class="overflow-x-auto w-full max-w-[1400px] px-4">
	  <table class="table table-lg bg-base-200 mb-[150px] w-full">
		<thead>
		  <tr class="bg-base-300">
			<th>ID</th>
			<th>Name</th>
			<th>Subject</th>
			<th>Class</th>
			<th></th>
		  </tr>
		</thead>
		<tbody id="chapter_table_body">
		  {% for chapter in chapters %}
		  <tr id="{{ chapter.id }}">
			<td class="whitespace-nowrap">{{ chapter.id }}</td>
			<td class="whitespace-nowrap">{{ chapter.name }}</td>
			<td class="whitespace-nowrap">{{ chapter.subject_name }}</td>
			<td class="whitespace-nowrap">{{ chapter.class_name }}</td>
			<th>
			  <button
				class="cursor-pointer iconify mdi--bin-outline w-[22px] h-[22px] text-red-500"
				onclick="deleteChapter('{{ chapter.id }}','{{ chapter.name }}')"
			  ></button>
			</th>
		  </tr>
		  {% endfor %}
		</tbody>
	  </table>
	</div>
</main>


{% endblock %}
